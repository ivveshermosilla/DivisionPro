<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DivisionesPro V1.0.7</title>
    <style>
        :root {
            --primary: #2c3e50; --success: #27ae60; --error: #e74c3c;
            --highlight: #f1c40f; --bg: #ecf0f1; --blue: #3498db;
        }
        body { font-family: 'Arial', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .game-container { display: flex; gap: 40px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); align-items: flex-start; }
        .division-area { font-size: 3rem; display: flex; flex-direction: column; gap: 10px; min-width: 500px; }
        .main-row { display: flex; align-items: center; gap: 12px; height: 85px; }
        .digit { 
            box-sizing: border-box; width: 60px; height: 75px; border: 3px solid #bdc3c7; 
            display: inline-flex; justify-content: center; align-items: center; border-radius: 10px; background: #f9f9f9;
        }
        .digit.selected { background: var(--highlight); border-color: #d35400; }
        .digit.used { text-decoration: line-through; opacity: 0.3; background: #ddd; }
        .blink-soft { animation: blink-animation 1.5s infinite; border-color: var(--blue) !important; }
        @keyframes blink-animation { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .drop-zone {
            box-sizing: border-box; width: 60px; height: 75px; border: 3px dashed #bdc3c7; 
            display: inline-flex; justify-content: center; align-items: center; border-radius: 10px; background: #fff; font-weight: bold;
        }
        .drop-zone.correct { background: var(--success); color: white; border: 3px solid #1e8449; }
        .drop-zone.incorrect { background: var(--error); color: white; border: 3px solid #922b21; cursor: pointer; }
        .drop-zone.active-blue { background: var(--blue); border: 3px solid #21618c; color: white; border-style: solid; }
        .drop-zone.working-yellow { background: var(--highlight); color: #000; border: 3px solid #d35400; border-style: solid; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .num-key {
            width: 65px; height: 65px; background: var(--primary); color: white;
            display: flex; justify-content: center; align-items: center; border-radius: 10px;
            cursor: grab; font-size: 1.6rem; font-weight: bold;
        }
        .residue-row { display: flex; gap: 10px; margin-top: 5px; height: 80px; align-items: center; }
        .row-history { opacity: 0.4; pointer-events: none; }
        #message-box {
            margin-top: 25px; padding: 20px; background: var(--primary); color: white;
            border-radius: 12px; min-width: 600px; text-align: center; font-size: 1.3rem;
        }
        .next-btn { background: var(--success); padding: 10px 25px; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="game-container">
    <div class="division-area">
        <div class="main-row">
            <div id="dividend-display" style="display:flex; gap:5px;"></div>
            <span>:</span>
            <div id="divisor-display" style="font-weight:bold;"></div>
            <span>=</span>
            <div id="quotient-display" style="display:flex; gap:5px;"></div>
        </div>
        <div id="work-area"></div>
    </div>
    <div class="numpad" id="numpad"></div>
</div>
<div id="message-box"></div>

<script>
    let game = {
        qIndex: 1, dividend: 0, divisor: 0, divDigits: [],
        step: 'SELECT', selectedIndices: [], currentWorkingVal: 0,
        quotientFound: [], rows: [], usedIndices: [], currentResidueValue: undefined
    };

    function init() {
        const pad = document.getElementById('numpad');
        [1,2,3,4,5,6,7,8,9,0].forEach(n => {
            const btn = document.createElement('div');
            btn.className = 'num-key';
            btn.innerText = n;
            btn.draggable = true;
            btn.ondragstart = (e) => { e.dataTransfer.setData("text", n); e.dataTransfer.setData("type", "number"); };
            pad.appendChild(btn);
        });
        newQuestion();
    }

    function newQuestion() {
        game.dividend = 316; // Siguiendo el ejemplo de tu imagen para prueba
        game.divisor = 7;
        game.divDigits = game.dividend.toString().split('').map(Number);
        game.quotientLength = Math.floor(game.dividend / game.divisor).toString().length;
        game.selectedIndices = []; game.usedIndices = []; game.quotientFound = [];
        game.rows = []; game.step = 'SELECT'; game.currentResidueValue = undefined;
        render();
    }

    function hasError() { return document.querySelector('.incorrect') !== null; }

    function render() {
        const errorPresent = hasError();
        
        // 1. Dividendo
        const divDisp = document.getElementById('dividend-display');
        divDisp.innerHTML = '';
        game.divDigits.forEach((d, i) => {
            const span = document.createElement('span');
            span.className = 'digit';
            if (game.usedIndices.includes(i)) span.classList.add('used');
            else if (game.selectedIndices.includes(i)) span.classList.add('selected');
            
            if (!errorPresent && game.step === 'SELECT' && i === game.selectedIndices.length) span.classList.add('blink-soft');
            if (!errorPresent && game.step === 'BRINGDOWN' && i === (Math.max(...game.selectedIndices) + 1)) {
                span.classList.add('blink-soft');
                span.draggable = true;
                span.ondragstart = (e) => { e.dataTransfer.setData("type", "bringdown"); e.dataTransfer.setData("idx", i); };
            }
            span.innerText = d;
            span.onclick = () => { if(!errorPresent && game.step === 'SELECT') handleDigitClick(i); };
            divDisp.appendChild(span);
        });

        document.getElementById('divisor-display').innerText = game.divisor;

        // 2. Cociente (Validación de ORDEN ESTRICTO)
        const quoDisp = document.getElementById('quotient-display');
        quoDisp.innerHTML = '';
        for(let i=0; i < game.quotientLength; i++) {
            const box = document.createElement('div');
            box.className = 'drop-zone';
            const qObj = game.quotientFound[i];
            
            if(qObj !== undefined) {
                box.innerText = qObj.val;
                if(qObj.isLocked) box.classList.add('correct');
                else {
                    const isCorrect = (qObj.val === Math.floor(game.currentWorkingVal / game.divisor));
                    if(isCorrect) box.classList.add('correct');
                    else {
                        box.classList.add('incorrect');
                        box.onclick = () => { game.quotientFound.splice(i, 1); render(); };
                    }
                }
            } else if(!errorPresent && game.step === 'QUOTIENT' && i === game.quotientFound.length) {
                box.classList.add('blink-soft'); // Solo parpadea la casilla que toca
            }
            box.ondragover = e => e.preventDefault();
            box.ondrop = e => { 
                // BLOQUEO: Solo permite soltar en la casilla actual que corresponde al orden
                if(i === game.quotientFound.length) handleDrop(e, 'Q', i); 
            };
            quoDisp.appendChild(box);
        }

        // 3. Área de trabajo (CASILLA AZUL RESTAURADA)
        const work = document.getElementById('work-area');
        work.innerHTML = '';
        game.rows.forEach(rowData => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'residue-row row-history';
            rowDiv.innerHTML = `<div class="drop-zone active-blue">${rowData.residue}</div>
                                <div class="drop-zone working-yellow">${rowData.nextDigit}</div>`;
            work.appendChild(rowDiv);
        });

        if (game.step !== 'SELECT' && game.step !== 'FINISH') {
            const activeRow = document.createElement('div');
            activeRow.className = 'residue-row';
            
            const rBox = document.createElement('div');
            rBox.className = 'drop-zone';
            if (game.currentResidueValue !== undefined) {
                rBox.innerText = game.currentResidueValue;
                const isCorrect = (game.currentResidueValue === (game.currentWorkingVal % game.divisor));
                rBox.classList.add(isCorrect ? 'active-blue' : 'incorrect');
                if(!isCorrect) rBox.onclick = () => { game.currentResidueValue = undefined; render(); };
            } else if (!errorPresent && game.step === 'RESIDUE') {
                rBox.classList.add('active-blue'); // Casilla azul cuando espera residuo
                rBox.classList.add('blink-soft');
            }
            rBox.ondragover = e => e.preventDefault();
            rBox.ondrop = e => handleDrop(e, 'R');
            activeRow.appendChild(rBox);

            if (game.step === 'BRINGDOWN' || (game.step === 'QUOTIENT' && game.rows.length > 0)) {
                const bBox = document.createElement('div');
                bBox.className = 'drop-zone';
                if (game.step === 'QUOTIENT') {
                    bBox.innerText = game.divDigits[game.selectedIndices[game.selectedIndices.length-1]];
                    bBox.classList.add('working-yellow');
                } else if(!errorPresent) bBox.classList.add('blink-soft');
                bBox.ondragover = e => e.preventDefault();
                bBox.ondrop = e => handleDrop(e, 'B');
                activeRow.appendChild(bBox);
            }
            work.appendChild(activeRow);
        }

        updateMessage();
    }

    function handleDigitClick(i) {
        if(game.selectedIndices.includes(i)) {
            if(i === game.selectedIndices[game.selectedIndices.length-1]) game.selectedIndices.pop();
        } else if(i === game.selectedIndices.length) {
            game.selectedIndices.push(i);
            let val = parseInt(game.selectedIndices.map(idx => game.divDigits[idx]).join(''));
            if(val >= game.divisor || (i === 1 && game.divDigits[0] < game.divisor)) {
                game.currentWorkingVal = val;
                game.step = 'QUOTIENT';
            }
        }
        render();
    }

    function handleDrop(e, zoneType, idx) {
        e.preventDefault();
        const val = parseInt(e.dataTransfer.getData("text"));
        const dragType = e.dataTransfer.getData("type");

        if(dragType === "number") {
            if(zoneType === 'Q' && game.step === 'QUOTIENT') {
                const isCorrect = (val === Math.floor(game.currentWorkingVal / game.divisor));
                game.quotientFound[idx] = { val: val, isLocked: isCorrect };
                if(isCorrect) game.step = 'RESIDUE';
            } else if(zoneType === 'R' && game.step === 'RESIDUE') {
                game.currentResidueValue = val;
                if(val === (game.currentWorkingVal % game.divisor)) {
                    game.selectedIndices.forEach(i => { if(!game.usedIndices.includes(i)) game.usedIndices.push(i); });
                    if(game.usedIndices.length < game.divDigits.length) game.step = 'BRINGDOWN';
                    else game.step = 'FINISH';
                }
            }
        } else if(dragType === "bringdown" && zoneType === 'B') {
            const nextIdx = parseInt(e.dataTransfer.getData("idx"));
            if(game.quotientFound.length > 0) game.quotientFound[game.quotientFound.length-1].isLocked = true;
            game.usedIndices.push(nextIdx);
            game.rows.push({residue: game.currentResidueValue, nextDigit: game.divDigits[nextIdx]});
            game.selectedIndices.push(nextIdx);
            game.currentWorkingVal = parseInt(game.currentResidueValue.toString() + game.divDigits[nextIdx]);
            game.currentResidueValue = undefined;
            game.step = 'QUOTIENT';
        }
        render();
    }

    function updateMessage() {
        const msg = document.getElementById('message-box');
        if(hasError()) msg.innerText = "Corrige el número marcado en rojo para continuar";
        else if(game.step === 'FINISH') {
            const q = game.quotientFound.map(o => o.val).join('');
            msg.innerHTML = `<div>¡Correcto! ${game.dividend} : ${game.divisor} = ${q}${game.currentResidueValue>0?' y sobran '+game.currentResidueValue:''}</div>
                             <button class="next-btn" onclick="newQuestion()">Siguiente Pregunta</button>`;
        } else if(game.step === 'SELECT') msg.innerText = "Toca el número del dividendo";
        else if(game.step === 'QUOTIENT') msg.innerText = `¿Cuántas veces cabe el ${game.divisor} en el ${game.currentWorkingVal}?`;
        else if(game.step === 'RESIDUE') msg.innerText = "¿Cuánto sobra? Pon el residuo en la casilla azul";
        else if(game.step === 'BRINGDOWN') msg.innerText = "Arrastra el siguiente número hacia abajo";
    }

    init();
</script>
</body>
</html>